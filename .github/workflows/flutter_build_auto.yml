name: Auto Build Flutter APKs

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # ğŸŸ¢ Ø§Ø³ØªØ®Ø±Ø¬ Ù†Ø³Ø®Ø© Flutter Ù…Ù† pubspec.lock Ø£Ùˆ pubspec.yaml
      - name: Detect Flutter version
        id: flutter_version
        run: |
          if [ -f "pubspec.lock" ]; then
            VERSION=$(grep -A 1 "flutter:" pubspec.lock | grep "version:" | awk '{print $2}' | head -n 1)
          fi
          if [ -z "$VERSION" ] && [ -f "pubspec.yaml" ]; then
            VERSION=$(grep "sdk:" pubspec.yaml | sed 's/[^0-9.]//g' | head -n 1)
          fi
          if [ -z "$VERSION" ]; then
            VERSION="stable" # fallback
          fi
          echo "Detected Flutter version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ğŸŸ¢ Ù†Ø²Ù‘Ù„ Ù†Ø³Ø®Ø© Flutter Ø§Ù„Ù„ÙŠ Ø§ØªÙƒØ´ÙØª
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.flutter_version.outputs.version }}

      - name: Install dependencies
        run: flutter pub get

      # ğŸŸ¢ Build Split APKs
      - name: Build Split APKs
        run: flutter build apk --release --split-per-abi

      # ğŸŸ¢ Upload Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ APKs
      - name: Upload Split APKs
        uses: actions/upload-artifact@v3
        with:
          name: split-apks
          path: build/app/outputs/flutter-apk/*.apk
